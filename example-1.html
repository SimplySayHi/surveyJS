<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Demo 01 | surveyJS - Generate &amp; Manage a Survey from a JSON Object</title>
    <meta name="description" content="Generate & Manage a Survey from a JSON Object">
    <meta name="keywords" content="survey, question, answer, jquery, javascript, plugin, ajax, json">
    <meta name="author" content="Valerio Di Punzio">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Fredericka+the+Great|Raleway:200" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/stackSlider.css">
    <link rel="stylesheet" href="css/survey.css">
    <link rel="stylesheet" href="css/demo.css">
    <link rel="stylesheet" href="css/demo-stackslider.css">
</head>

<body>
    
    <div class="container">
        <div class="text-center">
            <h1>surveyJS</h1>
            <p>
                This survey is generated with Javascript/jQuery.
                <br />
                This demo uses <a href="https://getbootstrap.com/docs/4.0/components/forms/#custom-forms" target="_blank">Bootstrap 4 custom inputs</a>.
            </p>
        </div>
        <div class="surveyjs-container surveyjs-custom-inputs panel" data-surveyjs-container>
            <div class="panel-body">
                <form action="json/survey.json" name="surveyjs-form" class="surveyjs-form surveyjs-cards" data-surveyjs-form novalidate="">
                    <div class="surveyjs-question-box text-white text-right margin-lg" data-formjs-question>
                        <div class="surveyjs-answers-box form-group">
                            <div class="text-left small">
                                L'interessato persta il consenso al trattamento dei propri dati personali per la creazione di profili e per l'analisi delle sue abitudini o scelte di consumo sulla base del dettaglio dei suoi acquisti nonch&egrave; dei dati forniti direttamente dal cliente.
                            </div>
                            <div class="radio custom-radio custom-control custom-control-inline">
                                <input class="custom-control-input" data-exclude-storage="" data-name="bind-surveyjs-answer"/>
                                <label class="surveyjs-label custom-control-label">
                                    <span></span>
                                </label>
                            </div>
                            <div class="radio custom-radio custom-control custom-control-inline">
                                <input class="custom-control-input" data-exclude-storage="" data-name="bind-surveyjs-answer"/>
                                <label class="surveyjs-label custom-control-label">
                                    <span></span>
                                </label>
                            </div>
                            <div class="surveyjs-field-error-message small">
                                Per proseguire &egrave; necessario selezionare una risposta.
                            </div>
                        </div>
                    </div>
                    <div class="surveyjs-body questionsList clearfix stackSlider" data-surveyjs-body></div>
                    <div class="surveyjs-footer row">
                        <button class="surveyjs-submit-btn btn btn-red d-block mx-auto" type="submit">
                            <span class="surveyjs-submit-text">SEND</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="modal-notification" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Mission complete</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">X</span></button>
                </div>
                <div class="modal-body">
                    <div class="media">
                        <div class="media-left pr-3"><img src="img/survey-image.png" class="surveyjs-img" /></div>
                        <div class="media-body media-middle">
                            <h3 class="text-green">Congratulations!</h3>
                            <p class="m-0">
                                You completed the survey and gained <b>100 points</b>.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DYNAMICALLY LOAD POLYFILLS -> REQUIRED FOR FORMJS TO SUPPORT IE 10/11 -->
    <script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=Array.from,Element.prototype.closest,Element.prototype.matches,Event,WeakMap"></script>
    
    <script src="js/vendors/modernizr_custom_63321.js"></script>
    <script src="js/vendors/jquery-1.12.4.min.js"></script>
    <script src="js/vendors/bootstrap.bundle.min.js"></script>
    <script src="js/vendors/jquery_stackslider.js"></script>
    
    <script src="js/modules/web_storage.js"></script>
    <script src="js/modules/formJS.js"></script>
    <script src="js/modules/surveyJS.js"></script>
    
    <!-- MINIFIED VERSION WITH ALL MODULES -->
    <!--<script src="js/surveyJS.min.js"></script>-->
    
    <script type="text/javascript">
        $(function(){

            var $surveyCont = $('[data-surveyjs-container]'),
                $surveyForm = $surveyCont.find('[data-surveyjs-form]'),
                $surveyBtn = $surveyForm.find('.surveyjs-submit-btn');
            
            // SETUP FOR THE SURVEY
            SURVEY.setup({
                url: 'json/survey.json',

                // FOR BOOTSTRAP 4 CUSTOM INPUTS
                cssClasses: {
                    checkbox:   'custom-control-input',
                    radio:      'custom-control-input',
                    label:      'custom-control-label',
                    select:     'custom-select'
                },

                templates: {
                    question:   '<div class="st-item" data-title="#{{questionNumber}}">'+
                                    '<div data-question-id="{{questionId}}" data-question-index="{{questionNumber}}" data-formjs-question class="surveyjs-question-box clearfix" {{maxChoice}}>'+
                                        '<div class="surveyjs-question-body">'+
                                            '<div class="surveyjs-question-text">{{questionText}}</div>'+
                                            '<div class="surveyjs-answers-box form-group clearfix">'+
                                                '{{answersHtml}}'+
                                            '</div>'+
                                        '</div>'+
                                    '</div>'+
                                '</div>',

                    // FOR BOOTSTRAP 4 CUSTOM INPUTS
                    input:  '<div class="surveyjs-single-answer surveyjs-input-container surveyjs-answer-{{answerType}} custom-control form-check custom-{{answerType}}" data-answer-index="{{answerIndex}}">'+
                                '{{inputTagCode}}'+
                                '{{labelTagCode}}'+
                            '</div>',
                    inputGroup: '<div class="surveyjs-single-answer input-group" data-answer-index="{{answerIndex}}">'+
                                    '<div class="input-group-prepend">'+
                                        '<div class="input-group-text custom-control custom-radio surveyjs-answer-{{answerType}}">'+
                                            '<input type="{{answerType}}" name="surveyjs-answer-{{questionNumber}}" id="{{answerCode}}" data-answer-id="{{answerId}}" value="{{answerIdValue}}" {{attrRequired}} data-require-more="" class="surveyjs-input surveyjs-radio custom-control-input" />'+
                                            '<label for="{{answerCode}}" class="surveyjs-label custom-control-label">{{answerString}}</label>'+
                                        '</div>'+
                                    '</div>'+
                                    '{{relatedAnswerField}}'+
                                '</div>'
                },

                fieldOptions: {
                    onValidation: function( fields ){
                        if( fields.length > 1 ){
                            // GO TO THE FIRST UNANSWERED QUESTION
                            var $stWrapper = $('.surveyjs-form .st-wrapper'),
                                activeIndex = $stWrapper.find('.st-center').index(),
                                $invalidField = (function(){
                                    for( var f=0; f<fields.length; f++ ){
                                        var obj = fields[f];
                                        if( !obj.result && !$(obj.field).is('[data-name="bind-surveyjs-answer"]') ){
                                            return $(obj.field);
                                        }
                                    }
                                    return $();
                                })();
                            
                            if( $invalidField.length ){
                                
                                var invalidIndex = $invalidField.closest('.st-item').index(),
                                    clickDirection = ( activeIndex > invalidIndex ? 'prev' : 'next' ),
                                    $btn = ( clickDirection === 'prev' ? $stWrapper.find('nav > span:first-child') : $stWrapper.find('nav > span:last-child') ),
                                    clicksLength = ( clickDirection === 'prev' ? activeIndex - invalidIndex : invalidIndex - activeIndex );

                                for(var i=0; i<clicksLength; i++){
                                    $btn.trigger('mousedown.stackslider');
                                    $btn.trigger('mouseup.stackslider');
                                }
                                
                            }
                        } else {
                            console.log('validating field ', fields[0]);
                        }
                    }
                },
                formOptions: {
                    beforeSend: function( data ){
                        console.log('Survey formOptions.beforeSend call...', data);

                        if( !data.stopExecution ){
                            $surveyBtn.addClass('surveyjs-submit-sending');
                            $surveyCont.find('.alert').remove();
                            data.formData = 'surveyJSON=' + JSON.stringify( data.formData );
                        }

                        return data;
                    },
                    onSubmitComplete: function( ajaxData ){
                        console.log('formOptions.onSubmitComplete', ajaxData);
                        $surveyBtn.removeClass('surveyjs-submit-sending');
                    },
                    onSubmitError: function( ajaxData ){
                        console.log('Survey formOptions.onSubmitError', ajaxData);
                        // PRINT THE ERROR MESSAGE AFTER THE FORM
                        $surveyForm.closest('.surveyjs-container').append( '<div class="alert alert-danger text-center" role="alert"><p class="my-3">Generic error, please retry.</p></div>' );
                    },
                    onSubmitSuccess: function( ajaxData ){
                        console.log('Survey formOptions.onSubmitSuccess', ajaxData);
                        if( typeof ajaxData === 'string' ){
                            try{
                                ajaxData = JSON.parse(ajaxData);
                            } catch(error){
                                throw new Error('String returned from ajax call to "' + ajaxOptions.url + '" is not a valid JSON string');
                            }
                        }

                        if( $.isPlainObject( ajaxData ) ){
                            if( ajaxData.data.status === 'success' ){
                                // REMOVE THE SURVEY FORM FROM THE PAGE AND PRINT A RESPONSE MESSAGE
                                $surveyForm.parent().html( '<div class="alert alert-success text-center" role="alert"><p class="my-3">Great! You completed the mission.</p></div>' );

                                // OPEN THE BOOTSTRAP MODAL TO SHOW A CONGRATULATION MESSAGE
                                $('#modal-notification').modal('show');
                            } else {
                                // PRINT THE ERROR MESSAGE AFTER THE FORM
                                $surveyForm.closest('.surveyjs-container').append( '<div class="alert alert-danger text-center" role="alert"><p class="my-3">Generic error, please retry.</p></div>' );
                            }
                        }
                    }
                },

                onInitSuccess: function( data, $surveyForm ){
                    var $surveyBody = $surveyForm.find('.surveyjs-body'),
                        initStatus = data.status;
                    
                    if( initStatus === 'success' ){
                        $('.stackSlider').stackslider({ piles : false });
                    } else {
                        $surveyForm.find('.surveyjs-footer').remove();
                        $surveyBody.html( '<div class="surveyjs-message">Errore durante il caricamento. Per favore, ricarica la pagina.</div>' );
                    }
                },
                onInitError: function( jqXHR, textStatus, errorThrown, $surveyForm ){
                    console.log('_setJSONurl(\''+ $surveyForm.attr('action') +'\') RETURNED AN ERROR:');
                    console.log('XHR: ', jqXHR);
                    console.log('STATUS: ', textStatus);
                    console.log('ERROR: ', errorThrown);
                    
                    $surveyForm.find('.surveyjs-loading').html( '<div class="surveyjs-message">Errore durante il caricamento. Per favore, ricarica la pagina.</div>' );
                }
            });

        });
    </script>
</body>
</html>